### --- Prefix ---
# Using C-a (easier to reach than C-b, especially with Caps Lock as Ctrl)
unbind C-b
set-option -g prefix C-a
bind-key C-a send-prefix

### --- Terminal Settings ---
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc"
set -ga terminal-overrides ",*:Tc"

# WezTerm/Ghostty compatibility
set -ga terminal-overrides ",wezterm:Tc:RGB"
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

### --- Sensible Defaults ---
set -g mouse on
set -g history-limit 50000
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -s escape-time 0
setw -g mode-keys vi
set -g set-clipboard on
set -g focus-events on

### --- Reload Config ---
unbind r
bind r source-file ~/.tmux.conf \; display-message "Config reloaded!"

### --- Window/Pane Splitting ---
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

### --- Vim-style Pane Navigation ---
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Also allow Ctrl+hjkl without prefix (works with vim-tmux-navigator)
bind -n C-h select-pane -L
bind -n C-j select-pane -D
bind -n C-k select-pane -U
bind -n C-l select-pane -R

### --- Window Navigation ---
bind -r C-h select-window -t :-
bind -r C-l select-window -t :+

### --- Pane Resizing ---
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5
bind m resize-pane -Z  # Toggle zoom

### --- Session Management with FZF ---
# Fuzzy session switcher (prefix + s)
bind s display-popup -E -w 80% -h 80% "\
  tmux list-sessions -F '#S' | \
  fzf --reverse --header 'Select session:' --preview 'tmux list-windows -t {}' | \
  xargs tmux switch-client -t"

# Alternative binding (prefix + C-s)
bind C-s display-popup -E -w 80% -h 80% "\
  tmux list-sessions -F '#S' | \
  fzf --reverse --header 'Search sessions:' --preview 'tmux list-windows -t {}' | \
  xargs tmux switch-client -t"

# Traditional session list (prefix + S)
bind S choose-tree -Zs

# New session from project directory (prefix + n)
# Fuzzy search common project directories and create session named after folder
bind n display-popup -E -w 80% -h 80% "\
  fd -t d -d 1 . ~/Developer ~/work ~/projects ~/ 2>/dev/null | \
  fzf --reverse --header 'New session from project:' --preview 'ls -la {}' | \
  xargs -I {} sh -c 'tmux new-session -d -s \$(basename {}) -c {} && tmux switch-client -t \$(basename {})'"

### --- Pane Management ---
# Break pane to its own window (prefix + b)
bind b break-pane

# Join pane from another window (prefix + J - prompts for source)
bind J command-prompt -p "join pane from:" "join-pane -s '%%'"

# Swap panes
bind > swap-pane -D  # Swap with next pane
bind < swap-pane -U  # Swap with previous pane

# Synchronize panes toggle (send input to all panes)
bind y setw synchronize-panes \; display "Sync #{?pane_synchronized,ON,OFF}"

# Cycle through layouts (even-horizontal, even-vertical, main-horizontal, etc.)
bind Space next-layout

# Quick pane kill (no confirmation)
bind x kill-pane
bind X kill-window

### --- LazyGit Integration ---
# Open LazyGit in popup (prefix + g)
bind g display-popup -E -w 90% -h 90% -d "#{pane_current_path}" "lazygit"
# Fallback to split if popup not supported
bind G split-window -v -c '#{pane_current_path}' 'lazygit'

### --- Htop/System Monitor ---
bind t display-popup -E -w 90% -h 90% "htop 2>/dev/null || top"

### --- Copy Mode (vi-style) ---
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "pbcopy"

# Search in copy mode
bind -T copy-mode-vi / command-prompt -p "search:" "send -X search-forward \"%%%\""
bind -T copy-mode-vi ? command-prompt -p "search backward:" "send -X search-backward \"%%%\""

# Mouse scrolling in copy mode
bind-key -T copy-mode-vi WheelUpPane send-keys -X scroll-up
bind-key -T copy-mode-vi WheelDownPane send-keys -X scroll-down

# Paste
bind p paste-buffer
bind ] paste-buffer -p

### --- Status Bar ---
set -g status-interval 5
set -g status-left-length 60
set -g status-right-length 90
set -g status-justify centre

set -g status-left "#[fg=green]#S"
set -g status-right "#[fg=cyan]%Y-%m-%d #[fg=white]%H:%M"

### --- Plugins (TPM) ---
# Install: git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
# Then press PREFIX + I to install plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-resurrect'    # Save/restore sessions
set -g @plugin 'tmux-plugins/tmux-continuum'    # Auto-save sessions

# tmux-yank configuration
set -g @yank_selection 'clipboard'
set -g @yank_selection_mouse 'clipboard'
set -g @yank_action 'copy-pipe-and-cancel'

# tmux-resurrect configuration
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'       # Restore neovim sessions

# tmux-continuum configuration
set -g @continuum-restore 'on'                  # Auto-restore on tmux start
set -g @continuum-save-interval '10'            # Save every 10 minutes

# Initialize TPM (keep at bottom)
run '~/.tmux/plugins/tpm/tpm'
